
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.13/c3.min.css">

  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" />
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  
  <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.13/c3.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>

</head>
<body>

<div class="jumbotron text-center">
  <h1>ระบบบันทึกข้อมูลอุณภูมิ และ ความชื้น</h1>
  <p>สำนักงานสาธารณสุขอำเภอพนัสนิคม</p> 
</div>
  
<div class="container">
  <!-- <div class="row"> -->
    <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">Real time</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false">Data feed</a>
      </li>

    </ul>

    <div class="tab-content" id="pills-tabContent">
      <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
          

      <div class="text-center"><h3>Realtime data </h3> <span id="nowDate"></span></div>

      <div class="card my-4">
        <div class="card-body  text-center"> 
          <div id="chartRealtime" class="col"></div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body  text-center">    
        
          <!-- <div class="col"> -->
            
          <table id="tableRealTime" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>        
                    <th>วันที่ เวลา</th>
                    <th>ID</th>
                    <th>สถานที่</th>
                    <th>อุณหภูมิ °C</th>
                    <th>ความชื้น %</th>              
                </tr>
            </thead>
            
            <tfoot>
                <tr>
                  <th>วันที่ เวลา</th>
                  <th>ID</th>
                  <th>สถานที่</th>
                  <th>อุณหภูมิ °C</th>
                  <th>ความชื้น %</th>      
                
                </tr>
            </tfoot>
          </table>

        </div>
      </div>
    </div> <!-- tab real time -->

    <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
      <div class="text-center"><h3>Feed data </h3> <span id="deviceID">Device ID:</span></div>

      <div class="card my-4">
        <div class="card-body  text-center"> 
          <form class="mt-3">

            <div class="form-group row justify-content-md-center">
              <label for="inputEmail3" class="col-form-label">เลือกอุปกรณ์</label>
              <div class="col-sm-3">
                <select id="selectID" class="custom-select">
                  <option value=null selected>Select Device..</option>
             <!--      <option value="0001">01866</option>
                  <option value="0003">01867</option>
                  <option value="0003">01868</option>
                  <option value="0004">01869</option>
                  <option value="0005">01870</option> -->
                </select>
              </div>
              <div class="col-sm-3">
                <div class="input-group date" data-target-input="nearest">
                  <span for="inputEmail3" class="col-form-label mr-3">Start date </span>
                  <input type="text" class="form-control datetimepicker-input" id="datetimepickerStart" data-toggle="datetimepicker" data-target="#datetimepickerStart"/>
             <!--      <div class="input-group-append" data-target="#datetimepicker7" data-toggle="datetimepicker">
                      <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                  </div> -->
                </div>
              </div>
              <div class="col-sm-3">
                <div class="input-group date" id="datetimepickerEnd" data-target-input="nearest">
                  <label for="inputEmail3" class="col-form-label mr-3">End date </label>
                  <input type="text" class="form-control datetimepicker-input" id="datetimepickerEnd" data-toggle="datetimepicker" data-target="#datetimepickerEnd"/>
                </div>
              </div>
              <button type="button" class="btn btn-primary" id="btnFind">Find</button>

            </div>
          </form>
        </div>
      </div>

      <div class="card my-4">
        <div class="card-body  text-center"> 
          <div id="chartFeed"></div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body  text-center">    
          <table id="tableFeed" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>        
                    <th>วันที่ เวลา</th>
                    <th>ID</th>
                    <th>สถานที่</th>
                    <th>อุณหภูมิ °C</th>
                    <th>ความชื้น %</th>              
                </tr>
            </thead>
            
            <tfoot>
                <tr>
                  <th>วันที่ เวลา</th>
                  <th>ID</th>
                  <th>สถานที่</th>
                  <th>อุณหภูมิ °C</th>
                  <th>ความชื้น %</th>      
                
                </tr>
            </tfoot>
          </table>
      </div>

    </div> <!-- tab feed -->

  </div> <!-- <div class="tab-content" id="pills-tabContent"> -->
</div>


<script src="https://www.gstatic.com/firebasejs/7.8.0/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/7.8.0/firebase-database.js"></script>

<script>
  // default variable 
  var feedData = [
    {
      datetime: "2020-02-14 12:30:25",
      id: "0001",
      description: "asdfgh",
      temperature: "10",
      humidity: "25",
    },  
    {
      datetime: "2020-02-14 12:31:25",
      id: "0001",
      description: "asdfgh",
      temperature: "15",
      humidity: "25",
    },  
    {
      datetime: "2020-02-14 12:32:25",
      id: "0001",
      description: "asdfgh",
      temperature: "20",
      humidity: "25",
    },  
    {
      datetime: "2020-02-14 12:33:25",
      id: "0001",
      description: "asdfgh",
      temperature: "25",
      humidity: "25",
    },  
    {
      datetime: "2020-02-14 12:34:25",
      id: "0001",
      description: "asdfgh",
      temperature: "30",
      humidity: "25",
    },  
    {
      datetime: "2020-02-14 12:35:25",
      id: "0001",
      description: "asdfgh",
      temperature: "35",
      humidity: "25",
    },    
  ]

  var realtimeData = [
    {
      datetime: "2020-02-14 12:30:25",
      id: "0001",
      description: "asdfgh",
      temperature: "17",
      humidity: "25",
    }, 
    {
      datetime: "2020-02-14 12:30:25",
      id: "0002",
      description: "11223344",
      temperature: "7",
      humidity: "30",
    },    
  ]

  $(document).ready(function() {

    $('#btnFind').attr("disabled", true)

    var tableRealTime = $('#tableRealTime').DataTable( {
        "data": realtimeData,
        "columns": [
            { "data": "datetime" },
            { "data": "id" },
            { "data": "description" },
            { "data": "temperature" },
            { "data": "humidity" },
        ]
    } );

    var tableFeed = $('#tableFeed').DataTable( {
        "data": feedData,
        "columns": [
            { "data": "datetime" },
            { "data": "id" },
            { "data": "description" },
            { "data": "temperature" },
            { "data": "humidity" },
        ]
    } );

    var chartFeed = c3.generate({
      bindto: '#chartFeed',
      type: 'line',
      data: {
          json: feedData,
          keys: {
            x: 'datetime',
            value: ['temperature', 'humidity'],
          },
          axes: {
            'temperature': 'y',
            'humidity': 'y2',
          }
      },
      axis: {
        x: {
          type: 'category',
          // label: {
          //   text: 'Device id',
          //   // position: 'inner-left'
          // }
          tick: {
            count: 10,
          },
          
        },
        y: {
          label: { // ADD
              text: 'Temperature °C',
              position: 'outer-middle'
          }

        },
        y2: {
          show: true,
          label: {
              text: 'Humidity %',
              position: 'outer-middle'
          }
        }
      }

    });


    var chartRealtime = c3.generate({
      bindto: '#chartRealtime',
      type: 'line',
      data: {
          json: realtimeData,
          keys: {
            x: 'id',
            value: ['temperature', 'humidity'],
          },
          axes: {
            'temperature': 'y',
            'humidity': 'y2',
          }
      },
      axis: {
        x: {
          type: 'category',
          label: {
            text: 'Device id',
            // position: 'inner-left'
          }
          
        },
        y: {
          label: { // ADD
              text: 'Temperature °C',
              position: 'outer-middle'
          }

        },
        y2: {
          show: true,
          label: {
              text: 'Humidity %',
              position: 'outer-middle'
              // inner-top : default
              // inner-middle
              // inner-bottom
              // outer-top
              // outer-middle
              // outer-bottom
          }
        }
      }

    });

    $('#nowDate').text( moment(new Date()).format("DD-MM-YYYY HH:mm:ss") )


    setInterval(function () {
        $('#nowDate').text( moment(new Date()).format("DD-MM-YYYY HH:mm:ss") )
    }, 1000);

    var firebaseConfig = {
      apiKey: "AIzaSyDOz_a-CO1FPWvNO322BpUN9hgdtv2GsKU",
      authDomain: "test-702f6.firebaseapp.com",
      databaseURL: "https://test-702f6.firebaseio.com",
      projectId: "test-702f6",
      storageBucket: "test-702f6.appspot.com",
      messagingSenderId: "860182684889",
      appId: "1:860182684889:web:05aa165127f58604"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);


    let devices = []
    let dataDescription = []

    var query = firebase.database().ref("Temp/Device").orderByKey();
    query.once("value")
      .then(function(snapshot) {
        let n = snapshot.numChildren()
        let dataArr = []
        snapshot.forEach(function(childSnapshot) {
          // key will be "ada" the first time and "alan" the second time
          var key = childSnapshot.key;
          // childData will be the actual contents of the child
          var childData = childSnapshot.val();
          // console.log(' key, childData =', key, childData, n)
          dataArr.push(childData) 
          // Cancel enumeration
          // return true;
  
          if(--n == 0) filterDescription(dataArr)

      });
    });
    
    function filterDescription(dataArr) {
      console.log(' filterDescription dataArr =', dataArr)
      dataDescription = dataArr
      for(let i=0; i<dataArr.length; i++) {
        console.log(' xxxxxxxxxxxx =', dataArr[i].id)
        $('#selectID').append('<option value="' + dataArr[i].id + '">' + dataArr[i].id + '</option>')
      }
      
    }

    // listen data
    var listen = firebase.database().ref("Temp/Realtime");
    listen.on("value", function(snapshot) {
      let n = snapshot.numChildren()
      let dataArr = []
      snapshot.forEach(function(childSnapshot) {
        // key will be "ada" the first time and "alan" the second time
        var key = childSnapshot.key;
        // childData will be the actual contents of the child
        var childData = childSnapshot.val();
        // console.log(' key =', snapshot.numChildren(), key, childData)
        dataArr.push(childData) 
        // Cancel enumeration
        // return true;

        if(--n == 0) { 
          console.log('realtime listen ---------------------------------', n)
          let result = mapDescription(dataDescription, dataArr, 'Realtime')   
          // console.log(' mapDescription result =>', result)
          console.log('realtime listen =>', result) 
          // realtimeData = result  
          updateChart(result)
          
        }
   
      });
    });

    updateChart = (realtimeData) => {
      for(let i=0; i<realtimeData.length; i++) {
        realtimeData[i].datetime = moment(new Date(realtimeData[i].timestamp)).format("DD-MM-YYYY HH:mm:ss")
      }
      console.log('mapDescription from =>', realtimeData) 
      $('#tableRealTime').dataTable().fnClearTable();
      $('#tableRealTime').dataTable().fnAddData(realtimeData);

      $('#nowDate').css('backgroundColor', 'yellow');
      $('#nowDate').animate({
          'opacity': '0.5'
      }, 2000, function () {
          $('#nowDate').css({
              'backgroundColor': '#fff',
                  'opacity': '1'
          });
      });

      chartRealtime.load({
        json: realtimeData,
        keys: {
          x: 'id',
          value: ['temperature', 'humidity'],
        },
        axes: {
          'temperature': 'y',
          'humidity': 'y2',
        }
      });
    }

    function mapDescription(dataDescription, dataArr, from) {
      console.log(' mapDescription dataArr =', dataArr)
      let n = dataArr.length
      let result 
      // dataDescription.forEach((data) => {
      for(let i=0; i<dataDescription.length; i++) {

        result = dataArr.map((arr) => {
          if(dataDescription[i].id == arr.id) arr.description=dataDescription[i].description 
          return arr
        })    
      }
      console.log(' mapDescription result =>', result)
      return result
    }

    //feed data =====================================================

    $('#datetimepickerStart').datetimepicker();
    $('#datetimepickerEnd').datetimepicker();

    $("#datetimepickerStart").on("change.datetimepicker", function (e) {
      $('#datetimepickerEnd').datetimepicker('minDate', e.date);
    });
    $("#datetimepickerEnd").on("change.datetimepicker", function (e) {
      // $('#datetimepickerEnd').datetimepicker('maxDate', e.date);
    }); 

    $("#selectID").on("change", function (e) {
      let val =  $("#selectID option:selected").val()
      console.log('selectID...', $("#selectID option:selected").val())
      if(val == 'null') {
        $('#btnFind').attr("disabled", true)
        return
      }
      $('#datetimepickerStart').datetimepicker('defaultDate', new Date());
      $('#btnFind').attr("disabled", false)
    });
    $("#btnFind").on("click", function (e) {
      console.log('btFind...')
      let dts = new Date( $('#datetimepickerStart').datetimepicker('viewDate')).getTime();
      let dte = new Date( $('#datetimepickerEnd').datetimepicker('viewDate')).getTime();
      console.log('dts, dte ---------', dts, dte);
 
      let id = $("#selectID option:selected").val()
      $('#deviceID').text('Device ID: '+id)

      let dataRes = []
      var queryFilter = firebase.database().ref("Temp/Push/"+id)
        .orderByChild('timestamp')
        .startAt(dts)
        .endAt(dte) //.where({ id: '0001'});
      queryFilter.once("value")
        .then(function(snapshot) {
          let n = snapshot.numChildren()
          snapshot.forEach(function(childSnapshot) {
            // key will be "ada" the first time and "alan" the second time
            var key = childSnapshot.key;
            // childData will be the actual contents of the child
            var childData = childSnapshot.val();
            console.log('queryFilter key =', key, childData)
            dataRes.push(childData)         
            // Cancel enumeration
            // return true;

            if(--n == 0) { 
              console.log('feed all ---------------------------------', n, dataRes)
              let result = mapDescription(dataDescription, dataRes, 'Push')   
              updatePush(result)
              // ref.off('value', queryFilter);            
            }
        });
      });

      updatePush=(feedData)=> {
        for(let i=0; i<feedData.length; i++) {
          feedData[i].datetime = moment(new Date(feedData[i].timestamp)).format("DD-MM-YYYY HH:mm:ss")
        }
        console.log('updatePush from =>', feedData) 
        $('#tableFeed').dataTable().fnClearTable();
        $('#tableFeed').dataTable().fnAddData(feedData);

        $('#deviceID').css('backgroundColor', 'yellow');
        $('#deviceID').animate({
            'opacity': '0.5'
        }, 2000, function () {
            $('#deviceID').css({
                'backgroundColor': '#fff',
                    'opacity': '1'
            });
        });

        chartFeed.load({
          json: feedData,
          keys: {
            x: 'datetime',
            value: ['temperature', 'humidity'],
          },
          axes: {
            'temperature': 'y',
            'humidity': 'y2',
          }
        });
      }


    });





  } ); // $(document).ready(function() {

  </script>

</body>
</html>